# Basic configuration
# Sets up Ubuntu Trusty, which is needed for MySQL 5.6
language: java
dist: trusty
services:
  #- mysql
  - docker
jdk: oraclejdk8
sudo: required #to ensure we get a VM rather than a container for more memory

# These packages are required to run MySQL 5.6 on Trusty
#addons:
  #apt:
    #packages:
    #- mysql-server-5.6
    #- mysql-client-core-5.6
    #- mysql-client-5.6

# Increase the size of the heap
before_script:
  - "echo $JAVA_OPTS"
  - "export JAVA_OPTS=-Xmx1024m"
  - "git clone https://github.com/gchq/urlDependencies-plugin.git"
  - "pushd urlDependencies-plugin"
  - "./gradlew clean build publishToMavenLocal"
  - "popd"
  - "git clone https://github.com/gchq/stroom-resources.git"
  - "pushd stroom-resources/dev-resources/compose"
  #- "docker-compose -f hbase-kafka-mysql-stroom-zk.yml up -d"
  - "popd"

# We run a script to build dependencies and do database setup
#install: "./.travis.install.sh"
    
install: echo "skip 'gradle assemble' step to speed up build"

# We're running this as a script because our build is either too silent or too chatty and TravisCI will kill either way.
#script: travis_wait 30 ./gradlew -Pversion=$TRAVIS_TAG downloadUrlDependencies clean build -x test shadowJar
script: ./gradlew -Pversion=$TRAVIS_TAG downloadUrlDependencies clean build -x test shadowJar

# Push to DockerHub. The username and password were added using the Travis CLI.
# The configuration below will only push an image if the branch being built is master.
after_success:
  - if [ "$TRAVIS_BRANCH" == "dev" ]; then
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker build --tag=gchq/stroom:dev-latest stroom-app/.
    docker push gchq/stroom;
    fi

# Push to GitHub releases - the key was generated by the Travis CLI.
deploy:
  provider: releases
  api_key:
    secure: xUPJboaSjxs3lKCqXu5zYzdV75S+lu5EZ6RD+RigmQ5MSjeuFBhoBKYaJUz+ejaoFLfF8WSUbmlgTeRMK7QI4MtCqjy08uREext8sm0behMREz4mmPEb9eTLu+WfIXFbnOPG4pKzkAtHA3x+hNQN3EWga1Xa2WXGYdOuK1B7vnrYOPo9D2zI12JCaoXt0KUQ70LwE07uwBIuDn+0EbVsAftFatJh7jZXeMsE8GmdcwsM/DObKjtTLBH3bpE8pPPJ8H0ssuIsQk2jHg91cTgrlB0q0K1a5TjeKKMGPMY6S6UR9cB7l7FqCVEsOd7T/ExdKp1TflMRyuuKG9ACBXTaegfBt7pP7KYEpYtidC5p/b1J4cYvazVTIfo6m93wnOJAdcD1XeMqNIQZVSxNuflmgM8xZz+UuqPBF4dk3Z5Eoh4sTH+t6WmZY6YoIt6tRMQ8xRyvkTfzsfYUtsV4csyeB2oy5s/GJmYGtR5GjjK6T+mh8RmI/DVWW50ubdFaAYYdz+LSgfpGhBXEBkYPghMSjYiPDsJStXsOwRSQbR9LmRO7jk08PxxT33pLr8Ct0HoQPpSP8Fom4q1ntrZBDjeHL8/2cQtRKqUg3X9G0sU7aW5i0G4U7BE42Xkcc/VVJhFrVbRj5+xQq70uMyUmHi2Wh+mBQSY+ZlBrvr6FRcKj42E=
  file: stroom-app/build/libs/stroom-app-all.jar
  skip_cleanup: true
  on:
    tags: true

#clean out gradle caches as per travis docs
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

# Cache dependencies to speed up the build
cache:
  directories:
    - .autoconf
    - $HOME/.m2
    - libs
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
