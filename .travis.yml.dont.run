language: bash
os: linux
dist: focal

services:
  - docker # Gives us docker and compose

env:
  global:
    # $TAGPERM environment variable
    # generate a token at https://github.com/settings/tokens and encrypt it
    # with `travis encrypt -r gchq/stroom TAGPERM=<github personal access token>`
    # also see: https://docs.travis-ci.com/user/encryption-keys/#Usage
    - secure: "ttqWVHpz7iSdBlfDvybP61JPXHM76fdMUydy65a617wSJ7nX166hd9mgR0Bciwn5dZjCOVNcbjPnrZhjFq5QqkFyCzhm9lf8CakCf4oHccUXIufXxTfGUDxu/NVQqY2QMvCceawaeHKdnhHYFTDJWM++iHi3FE+FyHB3GN8PP4oiZnd54DwXS3w/4Sh+TFLFJ7wDGmIumr5J2lxv8ZOfie6DVEhGxYVQR2ZrQQp1h0EZVE7J7QUOW3ZTrTEHdxDZbOswLgn1GnT+DqLTr7y6YpuwkUvzGJ78uoyl8yWnVp/gZZWPwv/EbbjqrUS+xFKUNEOXIH3G5fnI3UJNpBBk8yXpi4ZA5rST1OSSK7q6ZWsgUCiQ/sVGukr4DEm9ym4NJRaqI9DQ8TkllP4W57zJ/TXN1cUeBEYjDH2R3a3iN5fczLyPyIFefovSW7VCFWTFwd0ZCdltVwU4gNkA/M39uX9NZPP75FgyF/trot6LL1YeS4wZWKs7g7NQ10vgJY0sPEWVoVOCZqjgUbN5t34LO76LD2kRkmx+zRPnmFYyWLmTIUl8xrywMsXVO3k6rhcWB54y4tQinKwUCcFeYzifwnwUhtUeduwNx0bkFnaSIDI2dXqz3i/EwcuJT9C4xxavkyNgGQYfuBRBnkGN6yMx4Cb1QNS3QQuopXyBDVT4xEI="
      # and: https://docs.travis-ci.com/user/best-practices-security/
    #travis encrypt -r gchq/stroom GH_USER_AND_TOKEN="*****"
    #where ***** is '<github username>:<github personal access token>'
    #Required for curling the gh api to get the latest release sha
    - secure: "S2NzvX3h+8F9Dti/hWPWfQaKaSHAvq5YxGI0CpeO702MWXHHu4rBQ/u8mUYKx36hztP80Wt9zvIPbSX1WPYhC3oAlAS7TADZG5YN3nwePnWdn6ZwNphEI3xxHs7YiSVxbb9ejNheJN1mNzg7zy9L81ofl+iZCWtlngtNt7M7/leBYLug75bQ/Hmc26X/orqv/C/dPbngB1eT9Th0AcfYiLpBlRfCEF01H8+Chaf4cuB9E2DDU1KBXOLC5t/Z1kMO329guCBp0MUonNJrvvI4e7cxUs1pB8EQKuWMpjyPoNaB8ikJli7eUPqEyfgYllZ7B3z4p3yKM50yNcbQ6tmhCwUa2AIhRB3Q3hS0fvoi4KISKPXwmA8LcdhgT9SpuUMbLntARgFyTXvJsJbHFKyHQSqd9gUAoDaNr5+HkuKXPRYinaeO0eL1AKX2RAXU/onYVABtODXt6k3uPzYZQ1dENyH5p6AdPUBZkAzTbkA2+0aNUCYRRObV457ilJ74vKrZQG3JQGltDzQWH7riTOLR2ERGnC0T6jVJxepivyTJz+ucULGaFs3f+X/WhhrTH/8xwS7fJPW9dtosISdrnk/2HWrUuMDK2j26xoiVphUu9CfOZmSWDV9bX5WPtbwT/DT+S0Pyyh+p/0yuJ7HyJB1gyhx2kBtoPEZCYXTCwXZuoP8="
    - SWAGGER_UI_GIT_TAG=v3.49.0
      # Map the travis env vars to the ones used in our script
    - BUILD_DIR=$TRAVIS_BUILD_DIR
    - BUILD_BRANCH=$TRAVIS_BRANCH
    - BUILD_TAG=$TRAVIS_TAG
    - BUILD_COMMIT=$TRAVIS_COMMIT
    - BUILD_IS_PULL_REQUEST=$TRAVIS_PULL_REQUEST
    - MAX_WORKERS=3

#install: echo "skip 'gradle assemble' step to speed up build"

script: ./ci_build.sh

deploy:
  # Deploy the swagger-ui content and swagger specs to gh-pages
  - provider: pages
    skip_cleanup: true
    github_token: $GITHUB_TOKEN
    local_dir: gh-pages
    target_branch: gh-pages
    on:
      # The swagger content should reflect the currently released version of stroom, hence 6.0 not master
      branch: "6.1"
      # A cron build on master should only be tagging commits and nothing else
      condition: "$TRAVIS_EVENT_TYPE != cron"
  # Push to GitHub releases for any tagged commit - the key was generated by the Travis CLI.
  - provider: releases
    api_key:
      # travis encrypt -r gchq/stroom <github personal access token>
      secure: "LC8wGnammcDZG444E/voqd7QYq25bSVoEVihhljTMyxAx0AhO53MSnjUo602ChH3Yxhp1U+rKL/rAa/wgof+bRx1Rka0YV5Rnu8NzPe6O8bVfQVRRVBUVcJxx2AJ9YlXCHpmEHl+nsMFS42QEt9bNdLhbCsOCmMJLvDeJ7PiquAemFQ6DT59i89IgL14QFvdZymyTf1IHJfBxfaXhlpUIBNCnRPwkU8wXA2Gzdkb90Ks9hmL1nfI/imdm5JNwsjIcJ91ItD2WijWbv2B35CEisn770EqnlDofHbROtTJbz3qBBwxl3sIGnRHcpL25zmTOZWbmqlgiMi6cQO3Dpt6bxmiSy4i6TQgna3LxQmCDeqQkSwAc8gJDw07y3Ktu6TeTad0KjrP/eOkyCqoNeRuqziI7Qzcpy7EHTQkPzhV+qkI0kUYBGA/VpYl579eA/Z0rNPBrBDVSiVPKNLB2B9cvVR3tk1V8VqWruzaauzBx1aGFp26bAAbyWHq/FzKMPV5ezKfGSG5ATqEx9hYVS4K66tljTSWT6pXMsl+Feu/S84s5KC5H8pKebq9j5j8w5HuyJSr2o6NUxNq8h1hyfTLZ3UOqXN/7EA1T02SQjwRJX27O9PHti7pXkOXAX8Q6qKlTinQnAOErngZj2ATPLlRqY7Bj/Vh1Ley0mmSLSBsXYo="
    file_glob: true
    file:
      # Put here by gather_release_artefacts()
      - "${TRAVIS_BUILD_DIR}/release_artefacts/*"
    skip_cleanup: true
    on:
      tags: true

#clean out gradle caches as per travis docs
#before_cache:
  #- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  #- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

# Cache dependencies to speed up the build
cache:
  directories:
    - .autoconf
    #- $HOME/.m2
    #- $HOME/.gradle/caches/
    #- $HOME/.gradle/wrapper/
      ## They are all versioned so no need to re-download them
    #- $TRAVIS_BUILD_DIR/build/contentPackDownload

