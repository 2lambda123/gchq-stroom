/*
 * Copyright 2016 Crown Copyright
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

----------------------------------------
-- Data Store
----------------------------------------

-- Stream Type
create table STRM_TP (ID INT generated by default as identity (start with 1), VER TINYINT not null, CRT_DT TIMESTAMP not null, CRT_USER varchar(255), UPD_DT TIMESTAMP not null, UPD_USER varchar(255), NAME varchar(255) not null, EXT varchar(255) not null, PATH varchar(255) not null, PURP tinyint not null, primary key (ID));
alter table STRM_TP add constraint UK_qnod8lgh4f7vre7tok9icnuw7  unique (NAME);

-- Feed
create table FD (ID INT generated by default as identity (start with 1), VER TINYINT not null, CRT_DT TIMESTAMP not null, CRT_USER varchar(255), UPD_DT TIMESTAMP not null, UPD_USER varchar(255), NAME varchar(255) not null, UUID varchar(255) not null, CLS varchar(255), CTX_ENC varchar(255), DESCRIP clob(255), ENC varchar(255), STAT tinyint not null, REF boolean not null, RETEN_DAY_AGE INT, FK_FOLDER_ID INT, FK_STRM_TP_ID INT not null, primary key (ID));
alter table FD add constraint UK_2afichft40ud2b9qr6wefb7pp  unique (NAME);
alter table FD add constraint UK_FD_UUID unique (UUID);
alter table FD add constraint FK_evt27bojexvg9cmv2k9nqsuj7 foreign key (FK_FOLDER_ID) references FOLDER;
alter table FD add constraint FK_o33vqh1bdhlms7f83p1sevn6v foreign key (FK_STRM_TP_ID) references STRM_TP;

-- Volume State
create table VOL_STATE (ID INT generated by default as identity (start with 1), VER TINYINT not null, BYTES_FREE BIGINT, BYTES_TOTL BIGINT, BYTES_USED BIGINT, STAT_MS BIGINT, primary key (ID));

-- Volume
create table VOL (ID INT generated by default as identity (start with 1), VER TINYINT not null, CRT_DT TIMESTAMP not null, CRT_USER varchar(255), UPD_DT TIMESTAMP not null, UPD_USER varchar(255), BYTES_LMT BIGINT, PATH varchar(255) not null, IDX_STAT tinyint not null, STRM_STAT tinyint not null, VOL_TP tinyint not null, FK_ND_ID INT not null, FK_VOL_STATE_ID INT not null, primary key (ID));
alter table VOL add constraint UK_bjee7ma80efbuva6a15w2frmx  unique (FK_VOL_STATE_ID);
alter table VOL add constraint UK_m42xo9wjtxi16gbir9avxotkx  unique (FK_ND_ID, PATH);
alter table VOL add constraint FK_97ct8ae3tl7o2icrt758fdyri foreign key (FK_ND_ID) references ND;
alter table VOL add constraint FK_bjee7ma80efbuva6a15w2frmx foreign key (FK_VOL_STATE_ID) references VOL_STATE;

-- Stream
create table STRM (ID BIGINT generated by default as identity (start with 1), VER TINYINT not null, CRT_MS BIGINT not null, EFFECT_MS BIGINT, PARNT_STRM_ID bigint, STAT tinyint not null, STAT_MS BIGINT not null, STRM_TASK_ID bigint, FK_FD_ID INT not null, FK_STRM_PROC_ID INT, FK_STRM_TP_ID INT not null, primary key (ID));
alter table STRM add constraint FK_s8lur9k80bmulc40jl333pffw foreign key (FK_FD_ID) references FD;
alter table STRM add constraint FK_ivj4ifhgae2qidsyixt0qs7oq foreign key (FK_STRM_PROC_ID) references STRM_PROC;
alter table STRM add constraint FK_axcsdyotm1reqp0u6xa5f6i41 foreign key (FK_STRM_TP_ID) references STRM_TP;

-- Stream Volume
create table STRM_VOL (ID BIGINT generated by default as identity (start with 1), VER TINYINT not null, FK_STRM_ID BIGINT not null, FK_VOL_ID INT not null, primary key (ID));
alter table STRM_VOL add constraint FK_ix34icclexfbw2g5gc0k6gjgr foreign key (FK_STRM_ID) references STRM;
alter table STRM_VOL add constraint FK_1i57lhiif8rbfvcfqy5glsr2v foreign key (FK_VOL_ID) references VOL;

-- Stream Attribute Key
create table STRM_ATR_KEY (ID INT generated by default as identity (start with 1), VER TINYINT not null, CRT_DT TIMESTAMP not null, CRT_USER varchar(255), UPD_DT TIMESTAMP not null, UPD_USER varchar(255), NAME varchar(255) not null, FLD_TP tinyint not null, primary key (ID));
alter table STRM_ATR_KEY add constraint UK_1ewbcjveqj9gj9u6wb13aq63n  unique (NAME);

-- Stream Attribute Value
create table STRM_ATR_VAL (ID BIGINT generated by default as identity (start with 1), VER TINYINT not null, CRT_MS BIGINT not null, STRM_ATR_KEY_ID INT not null, STRM_ID bigint not null, VAL_NUM bigint, VAL_STR varchar(255), primary key (ID));



-------
-- TODO : Move back to processing and reorder these (V2 data store, V3 pipelines, V4 processing) once the link from stream to stream processor has been broken
-------

-- Stream Task
create table STRM_TASK (ID BIGINT generated by default as identity (start with 1), VER TINYINT not null, CRT_MS BIGINT, END_TIME_MS BIGINT, STAT tinyint not null, START_TIME_MS BIGINT, STAT_MS BIGINT, DAT clob(2147483647), FK_ND_ID INT, FK_STRM_ID BIGINT not null, FK_STRM_PROC_FILT_ID INT, primary key (ID));
alter table STRM_TASK add constraint FK_ifcsuuiim93ao6bewe9g8i425 foreign key (FK_ND_ID) references ND;
alter table STRM_TASK add constraint FK_g997fpxe8ytx1nlcr5k258vuf foreign key (FK_STRM_ID) references STRM;
alter table STRM_TASK add constraint FK_ixpi95iraqrunytpophgw7adv foreign key (FK_STRM_PROC_FILT_ID) references STRM_PROC_FILT;